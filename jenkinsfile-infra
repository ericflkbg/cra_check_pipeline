pipeline {
    agent any

    environment {
        DOCKER_NETWORK = "jenkins"
        REGISTRY_CONTAINER_NAME = "registry"
        REGISTRY_PORT = "5000"
        REGISTRY_URL = "http://${REGISTRY_CONTAINER_NAME}:${REGISTRY_PORT}"
        TRIVY_SERVER_NAME = "trivy-server"
        TRIVY_SERVER_PORT = "4954"
        TRIVY_SERVER_URL = "http://${TRIVY_SERVER_NAME}:${TRIVY_SERVER_PORT}"
    }

    stages {
        stage('Start Docker Registry') {
            steps {
                script {
                    echo "Checking if Docker Registry is already running..."
                    def isRunning = sh(script: "docker ps -q -f name=${REGISTRY_CONTAINER_NAME}", returnStdout: true).trim()

                    if (!isRunning) {
                        echo "Starting Docker Registry container..."
                        sh """
                        docker stop ${REGISTRY_CONTAINER_NAME} || true
                        docker rm ${REGISTRY_CONTAINER_NAME} || true
                        docker run -d --name ${REGISTRY_CONTAINER_NAME} --network ${DOCKER_NETWORK} \
                        -p ${REGISTRY_PORT}:${REGISTRY_PORT} \
                        -v /var/lib/registry:/var/lib/registry \
                        registry:2
                        """
                        sleep 15 
                    } else {
                        echo "Docker Registry is already running!"
                    }

                    echo "Checking Docker Registry health..."
                    sh "curl -s ${REGISTRY_URL}/v2/ || (echo 'Docker Registry health check failed!' && exit 1)"
                }
            }
        }

        stage('Start Trivy Server') {
            steps {
                script {
                    echo "Checking if Trivy server is already running..."
                    def isRunning = sh(script: "docker ps -q -f name=${TRIVY_SERVER_NAME}", returnStdout: true).trim()

                    if (!isRunning) {
                        echo "Starting Trivy server..."
                        sh """
                        docker stop ${TRIVY_SERVER_NAME} || true
                        docker rm ${TRIVY_SERVER_NAME} || true
                        docker run -d --name ${TRIVY_SERVER_NAME} --network ${DOCKER_NETWORK} \
                        -v /var/lib/trivy:/root/.cache/trivy \
                        -p ${TRIVY_SERVER_PORT}:${TRIVY_SERVER_PORT} \
                        aquasec/trivy server --listen 0.0.0.0:${TRIVY_SERVER_PORT}
                        """
                        sleep 10 
                    } else {
                        echo "Trivy server is already running!"
                    }

                    echo "Checking Trivy server health..."
                    sh "curl -s ${TRIVY_SERVER_URL}/healthz || (echo 'Trivy server health check failed!' && exit 1)"
                }
            }
        }
    }

    post {
        always {
            echo "Docker Registry & Trivy Setup abgeschlossen!"
        }
        failure {
            echo "Fehler beim Starten der Dienste!"
        }
    }
}
